<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ—Ä–æ–±–µ–π - –ö–æ—É—á–∏–Ω–≥–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    
    <!-- PWA Meta —Ç–µ–≥–∏ -->
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ—É—á–∏–Ω–≥–∞ –∏ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ö–æ–ª–µ—Å–æ –±–∞–ª–∞–Ω—Å–∞">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCS0L7RgNC+0LHQtdC5IC0g0JrQvtGD0YfQuNC90LPQvtCy0L7QtSDQv9GA0LjQu9C+0LbQtdC90LjQtSIsCiAgInNob3J0X25hbWUiOiAi0JLQvtGA0L7QsdC10LkiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyNTYzZWIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEU0SWlCb1pXbG5hSFE5SWpFeE9DSWdkbWxsZDBKdmVEMGlNQ0F3SUFFNU1pQXhPVElpSUdacGJHdzlJaU5tWmpGaU16VWlQZzA4Y21WamRDQjNhV1IwYUQwaU1qZ2lJR2hsYVdkb2REMGlNamhpSWlCeWVEMGlOU0lnWm1sc2JEMGlJek15WkdaaVppSXZQZzBrUENoeVpXTjBJSGRwWkhSb1BTSXlOQ0lnYUdWcFoyaDBQU0l5TkNJZ2NuZzlJall1TlNJZ1ptbHNiRDBpSXpZNE5EWmlZU0l2UGcwOEwyNTJaejQ9IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- React –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f9fafb;
        }
        
        /* PWA —Å—Ç–∏–ª–∏ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #2563eb;
            color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-padding { padding: 1rem !important; }
            .mobile-text { font-size: 0.875rem !important; }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–µ—Å–∞ */
        .wheel-container {
            touch-action: manipulation;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–¥–∞—á */
        .task-card {
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateX(4px);
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- –ü—Ä–æ–º–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA -->
    <div id="install-prompt" class="install-prompt">
        <div class="flex items-center justify-between">
            <div>
                <p class="font-semibold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                <p class="text-sm opacity-90">–î–æ–±–∞–≤—å—Ç–µ –í–æ—Ä–æ–±–µ–π –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</p>
            </div>
            <div class="flex space-x-2">
                <button id="install-btn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium">
                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
                <button id="dismiss-btn" class="text-white opacity-70 px-2 py-2">
                    ‚úï
                </button>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ Firebase –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const firebaseConfig = {
          apiKey: "AIzaSyDbzjTfFUJi2A7ty0KISjzqJ429bLWqzB0",
          authDomain: "vorobey-coaching.firebaseapp.com",
          projectId: "vorobey-coaching",
          storageBucket: "vorobey-coaching.firebasestorage.app",
          messagingSenderId: "630213432372",
          appId: "1:630213432372:web:d111d5d7bdc302cdbea661"
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ Firebase
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
        if (isFirebaseConfigured) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        }

        // Firebase —Å–µ—Ä–≤–∏—Å—ã
        const auth = isFirebaseConfigured ? firebase.auth() : null;
        const db = isFirebaseConfigured ? firebase.firestore() : null;

        // –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
        class DataService {
            constructor() {
                this.useFirebase = isFirebaseConfigured;
                this.baseKey = 'vorobey_app_';
                
                if (!this.useFirebase) {
                    this.initializeLocalData();
                }
            }

            // –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (fallback)
            initializeLocalData() {
                if (!this.getLocalItem('initialized')) {
                    const defaultLifeAreas = [
                        { id: 1, name: '–ó–¥–æ—Ä–æ–≤—å–µ', current: 6, target: 10, color: '#22c55e' },
                        { id: 2, name: '–ë–∏–∑–Ω–µ—Å/–ö–∞—Ä—å–µ—Ä–∞', current: 7, target: 10, color: '#3b82f6' },
                        { id: 3, name: '–î—É—Ö–æ–≤–Ω–∞—è —Å—Ñ–µ—Ä–∞', current: 5, target: 10, color: '#8b5cf6' },
                        { id: 4, name: '–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç', current: 8, target: 10, color: '#f59e0b' },
                        { id: 5, name: '–û—Ç–Ω–æ—à–µ–Ω–∏—è', current: 6, target: 10, color: '#ef4444' },
                        { id: 6, name: '–§–∏–Ω–∞–Ω—Å—ã', current: 5, target: 10, color: '#10b981' },
                        { id: 7, name: '–î–æ—Å—É–≥/–•–æ–±–±–∏', current: 7, target: 10, color: '#f97316' },
                        { id: 8, name: '–°–µ–º—å—è', current: 8, target: 10, color: '#ec4899' }
                    ];

                    const defaultTasks = [
                        {
                            id: 1,
                            areaId: 1,
                            title: '–ü—Ä–æ–±–µ–∂–∫–∞ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é',
                            description: '–ë–µ–≥–∞—Ç—å –ø–æ 30 –º–∏–Ω—É—Ç –≤ –ø–∞—Ä–∫–µ',
                            result: '–£–ª—É—á—à–µ–Ω–∏–µ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏ –∏ –æ–±—â–µ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è',
                            reward: '–ü–æ–∫—É–ø–∫–∞ –Ω–æ–≤—ã—Ö –∫—Ä–æ—Å—Å–æ–≤–æ–∫',
                            penalty: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ',
                            status: 'in-progress',
                            plannedDate: new Date().toISOString().split('T')[0],
                            createdAt: new Date().toISOString(),
                            userId: 'demo-user'
                        }
                    ];

                    this.setLocalItem('life_areas', defaultLifeAreas);
                    this.setLocalItem('tasks', defaultTasks);
                    this.setLocalItem('initialized', true);
                }
            }

            getLocalItem(key) {
                try {
                    const item = localStorage.getItem(this.baseKey + key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.error('Error getting item:', e);
                    return null;
                }
            }

            setLocalItem(key, value) {
                try {
                    localStorage.setItem(this.baseKey + key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Error setting item:', e);
                    return false;
                }
            }

            // Firebase –º–µ—Ç–æ–¥—ã
            async getLifeAreas(userId) {
                if (!this.useFirebase) {
                    return this.getLocalItem('life_areas') || [];
                }

                try {
                    const doc = await db.collection('users').doc(userId).get();
                    return doc.exists ? (doc.data().lifeAreas || []) : [];
                } catch (error) {
                    console.error('Error getting life areas:', error);
                    return [];
                }
            }

            async updateLifeAreas(userId, lifeAreas) {
                if (!this.useFirebase) {
                    this.setLocalItem('life_areas', lifeAreas);
                    return true;
                }

                try {
                    await db.collection('users').doc(userId).set({
                        lifeAreas: lifeAreas,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error('Error updating life areas:', error);
                    return false;
                }
            }

            async getTasks(userId) {
                if (!this.useFirebase) {
                    const tasks = this.getLocalItem('tasks') || [];
                    return tasks.filter(task => task.userId === userId || task.userId === 'demo-user');
                }

                try {
                    const snapshot = await db.collection('tasks')
                        .where('userId', '==', userId)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('Error getting tasks:', error);
                    return [];
                }
            }

            async createTask(userId, taskData) {
                if (!this.useFirebase) {
                    const tasks = this.getLocalItem('tasks') || [];
                    const newTask = {
                        id: Date.now(),
                        ...taskData,
                        userId: userId,
                        status: 'todo',
                        createdAt: new Date().toISOString()
                    };
                    tasks.push(newTask);
                    this.setLocalItem('tasks', tasks);
                    return newTask;
                }

                try {
                    const newTask = {
                        ...taskData,
                        userId: userId,
                        status: 'todo',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = await db.collection('tasks').add(newTask);
                    return { id: docRef.id, ...newTask };
                } catch (error) {
                    console.error('Error creating task:', error);
                    throw error;
                }
            }

            async updateTask(taskId, updates) {
                if (!this.useFirebase) {
                    const tasks = this.getLocalItem('tasks') || [];
                    const updatedTasks = tasks.map(task => 
                        task.id === taskId ? { ...task, ...updates } : task
                    );
                    this.setLocalItem('tasks', updatedTasks);
                    return updatedTasks.find(task => task.id === taskId);
                }

                try {
                    await db.collection('tasks').doc(taskId).update({
                        ...updates,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating task:', error);
                    throw error;
                }
            }

            async deleteTask(taskId) {
                if (!this.useFirebase) {
                    const tasks = this.getLocalItem('tasks') || [];
                    const filteredTasks = tasks.filter(task => task.id !== taskId);
                    this.setLocalItem('tasks', filteredTasks);
                    return true;
                }

                try {
                    await db.collection('tasks').doc(taskId).delete();
                    return true;
                } catch (error) {
                    console.error('Error deleting task:', error);
                    throw error;
                }
            }

            // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–≤—è–∑—è–º–∏ –∫–æ—É—á-–∫–ª–∏–µ–Ω—Ç
            async getClientsByCoach(coachId) {
                if (!this.useFirebase) return [];

                try {
                    const snapshot = await db.collection('coachClientRelations')
                        .where('coachId', '==', coachId)
                        .get();
                    
                    const clientIds = snapshot.docs.map(doc => doc.data().clientId);
                    
                    if (clientIds.length === 0) return [];
                    
                    const clientsSnapshot = await db.collection('users')
                        .where(firebase.firestore.FieldPath.documentId(), 'in', clientIds)
                        .get();
                    
                    return clientsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('Error getting clients:', error);
                    return [];
                }
            }

            async addClientToCoach(coachId, clientEmail) {
                if (!this.useFirebase) return false;

                try {
                    // –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ email
                    const userSnapshot = await db.collection('users')
                        .where('email', '==', clientEmail)
                        .get();
                    
                    if (userSnapshot.empty) {
                        throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    const clientData = userSnapshot.docs[0];
                    const clientId = clientData.id;
                    
                    // –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å
                    await db.collection('coachClientRelations').add({
                        coachId: coachId,
                        clientId: clientId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Error adding client:', error);
                    throw error;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –¥–∞–Ω–Ω—ã—Ö
        const dataService = new DataService();

        const CoachingApp = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentView, setCurrentView] = useState('login');
            const [lifeAreas, setLifeAreas] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [clients, setClients] = useState([]);
            const [selectedClient, setSelectedClient] = useState(null);
            const [selectedArea, setSelectedArea] = useState(null);
            const [showNewTaskForm, setShowNewTaskForm] = useState(false);
            const [showAreaDetail, setShowAreaDetail] = useState(false);
            const [showAddClientForm, setShowAddClientForm] = useState(false);
            const [loading, setLoading] = useState(false);
            const [notification, setNotification] = useState(null);
            const [newTask, setNewTask] = useState({
                title: '',
                description: '',
                result: '',
                reward: '',
                penalty: '',
                areaId: 1,
                plannedDate: ''
            });
            const [newClientEmail, setNewClientEmail] = useState('');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            useEffect(() => {
                if (isFirebaseConfigured && auth) {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
                            try {
                                await db.collection('users').doc(user.uid).set({
                                    name: user.displayName || user.email,
                                    email: user.email,
                                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true });
                                
                                setCurrentUser({
                                    id: user.uid,
                                    name: user.displayName || user.email,
                                    email: user.email,
                                    role: user.email.includes('coach') ? 'coach' : 'client'
                                });
                                setCurrentView('dashboard');
                                await loadUserData(user.uid);
                            } catch (error) {
                                console.error('Error saving user data:', error);
                            }
                        } else {
                            setCurrentUser(null);
                            setCurrentView('login');
                        }
                    });

                    return () => unsubscribe();
                } else {
                    // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –¥–µ–º–æ
                    loadUserData('demo-user');
                }
            }, []);

            const loadUserData = async (userId) => {
                setLoading(true);
                try {
                    const [areasData, tasksData] = await Promise.all([
                        dataService.getLifeAreas(userId),
                        dataService.getTasks(userId)
                    ]);
                    
                    setLifeAreas(areasData);
                    setTasks(tasksData);

                    // –ï—Å–ª–∏ –∫–æ—É—á, –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤
                    if (currentUser?.role === 'coach' && isFirebaseConfigured) {
                        const clientsData = await dataService.getClientsByCoach(userId);
                        setClients(clientsData);
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            const handleGoogleLogin = async () => {
                if (!isFirebaseConfigured) {
                    // –î–µ–º–æ —Ä–µ–∂–∏–º
                    setCurrentUser({
                        id: 'demo-user',
                        name: '–î–µ–º–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        email: 'demo@example.com',
                        role: 'client'
                    });
                    setCurrentView('dashboard');
                    await loadUserData('demo-user');
                    return;
                }

                setLoading(true);
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google', 'error');
                    console.error(error);
                } finally {
                    setLoading(false);
                }
            };

            const handleEmailLogin = async (email, password) => {
                if (!isFirebaseConfigured) {
                    // –î–µ–º–æ —Ä–µ–∂–∏–º
                    setCurrentUser({
                        id: 'demo-user',
                        name: email.includes('coach') ? '–î–µ–º–æ –ö–æ—É—á' : '–î–µ–º–æ –ö–ª–∏–µ–Ω—Ç',
                        email: email,
                        role: email.includes('coach') ? 'coach' : 'client'
                    });
                    setCurrentView('dashboard');
                    await loadUserData('demo-user');
                    return;
                }

                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        try {
                            await auth.createUserWithEmailAndPassword(email, password);
                        } catch (signUpError) {
                            showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                        }
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                if (isFirebaseConfigured && auth) {
                    await auth.signOut();
                } else {
                    setCurrentUser(null);
                    setCurrentView('login');
                }
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            };

            const updateAreaScore = async (areaId, newScore) => {
                try {
                    const updatedAreas = lifeAreas.map(area =>
                        area.id === areaId ? { ...area, current: newScore } : area
                    );
                    
                    setLifeAreas(updatedAreas);
                    await dataService.updateLifeAreas(currentUser.id, updatedAreas);
                    showNotification('–û—Ü–µ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏', 'error');
                }
            };

            const toggleTaskStatus = async (taskId) => {
                try {
                    const task = tasks.find(t => t.id === taskId);
                    const newStatus = task.status === 'completed' ? 'todo' : 'completed';
                    
                    await dataService.updateTask(taskId, { status: newStatus });
                    setTasks(prev => prev.map(task => 
                        task.id === taskId ? { ...task, status: newStatus } : task
                    ));
                    
                    showNotification(newStatus === 'completed' ? '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!' : '–ó–∞–¥–∞—á–∞ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏', 'error');
                }
            };

            const createTask = async () => {
                if (!newTask.title || !newTask.plannedDate) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞—Ç—É', 'error');
                    return;
                }
                
                try {
                    const userId = selectedClient ? selectedClient.id : currentUser.id;
                    const task = await dataService.createTask(userId, newTask);
                    setTasks(prev => [...prev, task]);
                    setNewTask({
                        title: '',
                        description: '',
                        result: '',
                        reward: '',
                        penalty: '',
                        areaId: 1,
                        plannedDate: ''
                    });
                    setShowNewTaskForm(false);
                    showNotification('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏', 'error');
                }
            };

            const addClient = async () => {
                if (!newClientEmail || !isFirebaseConfigured) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ email –∫–ª–∏–µ–Ω—Ç–∞', 'error');
                    return;
                }

                try {
                    await dataService.addClientToCoach(currentUser.id, newClientEmail);
                    const clientsData = await dataService.getClientsByCoach(currentUser.id);
                    setClients(clientsData);
                    setNewClientEmail('');
                    setShowAddClientForm(false);
                    showNotification('–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
                } catch (error) {
                    showNotification(error.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞', 'error');
                }
            };

            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            const NotificationComponent = () => {
                if (!notification) return null;
                
                return (
                    <div className={`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                        notification.type === 'error' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-green-500 text-white'
                    }`}>
                        {notification.message}
                    </div>
                );
            };

            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏
            const LoadingSpinner = () => (
                <div className="flex items-center justify-center p-4">
                    <div className="loader"></div>
                </div>
            );

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Firebase
            const FirebaseWarning = () => {
                if (isFirebaseConfigured) return null;
                
                return (
                    <div className="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
                        <div className="flex">
                            <div className="flex-shrink-0">
                                ‚ö†Ô∏è
                            </div>
                            <div className="ml-3">
                                <p className="text-sm text-yellow-700">
                                    <strong>–î–µ–º–æ —Ä–µ–∂–∏–º:</strong> Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ.
                                    <br />
                                    <a href="#setup" className="underline">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const LoginForm = () => {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">üê¶ –í–æ—Ä–æ–±–µ–π</h1>
                                <p className="text-gray-600">–ö–æ—É—á–∏–Ω–≥–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è</p>
                            </div>
                            
                            <FirebaseWarning />
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="your@email.ru"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    />
                                </div>
                                
                                <button
                                    onClick={() => handleEmailLogin(email, password)}
                                    disabled={loading}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50"
                                >
                                    {loading ? <LoadingSpinner /> : '–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}
                                </button>

                                {isFirebaseConfigured && (
                                    <>
                                        <div className="text-center text-gray-500">–∏–ª–∏</div>
                                        
                                        <button
                                            onClick={handleGoogleLogin}
                                            disabled={loading}
                                            className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition-colors font-medium disabled:opacity-50 flex items-center justify-center space-x-2"
                                        >
                                            <span>üîë</span>
                                            <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                                        </button>
                                    </>
                                )}
                            </div>
                            
                            <div className="mt-6 text-center text-sm text-gray-500">
                                <p className="mb-2">–î–µ–º–æ –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
                                <div className="space-y-1">
                                    <button 
                                        onClick={() => {setEmail('coach@demo.ru'); setPassword('demo123');}}
                                        className="block w-full text-blue-600 hover:text-blue-700"
                                    >
                                        –ö–æ—É—á: coach@demo.ru / demo123
                                    </button>
                                    <button 
                                        onClick={() => {setEmail('client@demo.ru'); setPassword('demo123');}}
                                        className="block w-full text-blue-600 hover:text-blue-700"
                                    >
                                        –ö–ª–∏–µ–Ω—Ç: client@demo.ru / demo123
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∫–æ–ª–µ—Å–æ, –∑–∞–¥–∞—á–∏, etc.) –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ...
            // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –Ω–µ –±—É–¥—É –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥, –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è - —ç—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Firebase

            // –ì–ª–∞–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥
            const Dashboard = () => {
                const completedTasks = tasks.filter(task => task.status === 'completed').length;
                const totalTasks = tasks.length;
                const averageScore = lifeAreas.length > 0 ? Math.round(lifeAreas.reduce((sum, area) => sum + area.current, 0) / lifeAreas.length) : 0;
                const todayTasks = tasks.filter(task => task.plannedDate === new Date().toISOString().split('T')[0]);

                if (loading) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                            <LoadingSpinner />
                        </div>
                    );
                }

                // –ü—Ä–æ—Å—Ç–æ–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                return (
                    <div className="min-h-screen bg-gray-50">
                        <header className="bg-white shadow-sm border-b sticky top-0 z-40">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex justify-between items-center py-4">
                                    <div className="flex items-center space-x-4">
                                        <h1 className="text-xl md:text-2xl font-bold text-gray-900">üê¶ –í–æ—Ä–æ–±–µ–π</h1>
                                        <span className="text-sm text-gray-500 hidden md:inline">
                                            {currentUser?.name}
                                        </span>
                                    </div>
                                    
                                    <div className="flex items-center space-x-4">
                                        {!isFirebaseConfigured && (
                                            <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                                –î–ï–ú–û
                                            </span>
                                        )}
                                        <button
                                            onClick={handleLogout}
                                            className="text-gray-600 hover:text-gray-900 px-3 py-2"
                                        >
                                            üö™ –í—ã–π—Ç–∏
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <FirebaseWarning />
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div className="bg-white p-6 rounded-xl shadow-lg fade-in">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
                                            <p className="text-3xl font-bold text-gray-900">{averageScore}/10</p>
                                        </div>
                                        <div className="bg-blue-100 p-3 rounded-full">üìä</div>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-6 rounded-xl shadow-lg fade-in">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
                                            <p className="text-3xl font-bold text-gray-900">{completedTasks}/{totalTasks}</p>
                                        </div>
                                        <div className="bg-green-100 p-3 rounded-full">‚úÖ</div>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-6 rounded-xl shadow-lg fade-in">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-gray-600">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
                                            <p className="text-3xl font-bold text-gray-900">{totalTasks > 0 ? Math.round((completedTasks/totalTasks)*100) : 0}%</p>
                                        </div>
                                        <div className="bg-purple-100 p-3 rounded-full">üìà</div>
                                    </div>
                                </div>
                            </div>

                            {!isFirebaseConfigured && (
                                <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                                    <h3 className="text-lg font-semibold mb-4">üöÄ –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é:</h3>
                                    <ol className="list-decimal list-inside space-y-2 text-sm">
                                        <li>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ <a href="https://console.firebase.google.com" target="_blank" rel="noopener noreferrer" className="text-blue-600 underline">Firebase Console</a></li>
                                        <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase</li>
                                        <li>–í—Å—Ç–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ–¥ –≤–º–µ—Å—Ç–æ "YOUR_API_KEY" –∏ —Ç.–¥.</li>
                                        <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Firestore Database –∏ Authentication</li>
                                        <li>–î–µ–ø–ª–æ–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é</li>
                                    </ol>
                                    <p className="text-sm text-gray-600 mt-4">
                                        –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—É—á–∏—Ç–µ: –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É, —Å–≤—è–∑—å –∫–æ—É—á-–∫–ª–∏–µ–Ω—Ç, 
                                        —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ Google.
                                    </p>
                                </div>
                            )}
                            
                            <div className="text-center py-12">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    {isFirebaseConfigured 
                                        ? '–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π'
                                        : '–î–µ–º–æ –≤–µ—Ä—Å–∏—è - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏'
                                    }
                                </p>
                                <div className="flex flex-wrap justify-center gap-4">
                                    <div className="bg-green-100 text-green-800 px-4 py-2 rounded-lg">
                                        ‚úÖ PWA –≥–æ—Ç–æ–≤–æ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
                                    </div>
                                    <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                                        üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
                                    </div>
                                    <div className="bg-purple-100 text-purple-800 px-4 py-2 rounded-lg">
                                        üé® –ö—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                                    </div>
                                </div>
                            </div>
                        </div>

                        <NotificationComponent />
                    </div>
                );
            };

            // –ì–ª–∞–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
            if (!currentUser) {
                return <LoginForm />;
            }

            return <Dashboard />;
        };

        // PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installPrompt = document.getElementById('install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'block';
            }
        });

        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('install-prompt').style.display = 'none';
            }
        });

        document.getElementById('dismiss-btn')?.addEventListener('click', () => {
            document.getElementById('install-prompt').style.display = 'none';
        });

        // Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'vorobey-v2';
                    const urlsToCache = [
                        '/',
                        '/manifest.json'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('SW registered'))
                    .catch(() => console.log('SW registration failed'));
            });
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(CoachingApp));
    </script>
</body>
</html>